<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Dashboard: Roleplay Submissions Analysis</title>
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

    <style>
        /* 1. Base Styles */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
        body { 
            font-family: 'Sarabun', sans-serif;
            padding: 20px; 
            background-color: #f4f7f6;
            color: #333;
        }
        .container-box {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        h1 { 
            font-size: 36px;
            color: #d9534f;
            margin-bottom: 25px;
            text-align: center;
        }
        h2 { 
            font-size: 24px;
            color: #337ab7;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        
        /* 2. User List (Sidebar Style) */
        #userList {
            max-height: 70vh;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            padding-right: 15px;
        }
        .user-card {
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border-left: 5px solid #ccc;
        }
        .user-card:hover {
            background-color: #e9ecef;
            border-left-color: #337ab7;
        }
        .user-card.active {
            background-color: #d1ecf1;
            border-left-color: #007bff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }

        /* 3. Session Details */
        #sessionDetails {
            padding-left: 25px;
            min-height: 500px; 
        }
        .turn-item {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #fff;
        }
        .turn-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #d9534f;
        }
        .audio-pair {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .audio-block {
            flex: 1;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 6px;
        }
        .audio-block label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .customer-audio { border-color: #5cb85c; background-color: #f0fff0; }
        .employee-audio { border-color: #337ab7; background-color: #f5faff; }

        /* 4. Layout (Flexbox) */
        .dashboard-layout {
            display: flex;
            gap: 20px;
        }
        .col-3 { flex: 0 0 300px; } /* User List fixed width */
        .col-9 { flex: 1; } 

        /* 5. Utility */
        .text-center { text-align: center; }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        .mt-3 { margin-top: 1rem; }

        /* Custom Audio Player Style */
        .audio-player {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    
    <div class="container-box">
        <h1>Dashboard: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á Roleplay (Supabase)</h1>
        
        <div class="dashboard-layout">
            
            <div class="col-3">
                <h2>üë§ ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
                <div id="loadingIndicator" class="alert alert-info">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö...
                </div>
                <div id="userList">
                    </div>
            </div>
            
            <div class="col-9">
                <h2 id="sessionHeader">üéØ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Turn ‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö</h2>
                <div id="sessionDetails">
                    <p class="alert alert-info text-center">
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                    </p>
                    </div>
            </div>
            
        </div>
        
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // --- 1. Supabase Configuration (‡∏ô‡∏≥‡∏°‡∏≤‡∏à‡∏≤‡∏Å index1.html/index3.html) ---
        // ‡πÉ‡∏ä‡πâ URL ‡πÅ‡∏•‡∏∞ Key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'; 
        const supabase = createClient(supabaseUrl, supabaseKey);

        const userListElement = document.getElementById('userList');
        const sessionDetailsElement = document.getElementById('sessionDetails');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- 2. Data Fetching Functions ---

        /**
         * Fetch all unique users and their latest submission data.
         * Group by user_id and select the max created_at for sorting/overview.
         */
        async function fetchUsers() {
            loadingIndicator.style.display = 'block';
            
            // 1. Fetch all submission records
            const { data: allSubmissions, error } = await supabase
                .from('submissions')
                .select('user_id, name, user_group, created_at');

            if (error) {
                console.error("Error fetching submissions:", error);
                loadingIndicator.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`;
                return;
            }

            // 2. Group submissions by user_id and find the latest submission time
            const usersMap = {};
            allSubmissions.forEach(submission => {
                const { user_id, name, user_group, created_at } = submission;
                
                if (!usersMap[user_id] || new Date(created_at) > new Date(usersMap[user_id].latest_submission)) {
                    // Assume the last part (Part 5: Registration) is the marker of a completed test (approx)
                    const isCompleted = submission.part_number === 5; 
                    
                    usersMap[user_id] = {
                        user_id,
                        name: name || 'Anon User',
                        user_group: user_group || 'N/A',
                        latest_submission: created_at,
                        is_completed: isCompleted // Simple marker based on Part 5 submission
                    };
                }
            });

            const users = Object.values(usersMap).sort((a, b) => new Date(b.latest_submission) - new Date(a.latest_submission));
            
            loadingIndicator.style.display = 'none';
            renderUserList(users);
        }

        /**
         * Fetch all turns for a specific user ID, sorted by part and question number.
         */
        async function fetchTurns(userId, userName, userGroup) {
            document.getElementById('sessionHeader').textContent = `üéØ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤: ${userName} (${userGroup})`;
            sessionDetailsElement.innerHTML = '<p class="alert alert-info text-center mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</p>';
            
            // Query for all turns belonging to the selected user, ordered by part and question number
            const { data: turns, error } = await supabase
                .from('submissions')
                .select('*')
                .eq('user_id', userId)
                .order('part_number', { ascending: true })
                .order('question_number', { ascending: true });

            if (error) {
                sessionDetailsElement.innerHTML = `<p class="alert alert-danger text-center mt-3">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Turn: ${error.message}</p>`;
                console.error("Error fetching turns:", error);
                return;
            }

            renderSessionDetails(turns);
        }

        // --- 3. Rendering Functions ---

        function renderUserList(users) {
            userListElement.innerHTML = '';
            if (users.length === 0) {
                userListElement.innerHTML = '<p class="alert alert-info">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á submissions.</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div><strong>${user.name}</strong></div>
                    <small>‡∏Å‡∏•‡∏∏‡πà‡∏°: ${user.user_group} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(user.latest_submission).toLocaleDateString('th-TH')}</small>
                `;
                card.onclick = () => {
                    // Highlight selected user
                    document.querySelectorAll('.user-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    // Fetch and display turns
                    fetchTurns(user.user_id, user.name, user.user_group);
                };
                userListElement.appendChild(card);
            });
        }
        
        function getPartName(part) {
            switch (part) {
                case 1: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß/‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πâ‡∏ô‡∏™‡∏≤‡∏¢";
                case 15: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 1.5: ‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (Pitch)";
                case 2: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
                case 3: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Ç‡πâ‡∏≠‡πÇ‡∏ï‡πâ‡πÅ‡∏¢‡πâ‡∏á";
                case 4: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û";
                case 5: return "‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà 5: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤";
                default: return `Part ${part}`;
            }
        }
        
        function getQuestionDisplay(part, qNum) {
            if (part === 15) return `S1.5 Pitch`;
            if (part === 3 && qNum === 0) return `S3: Script ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢`;
            if (part === 4 && qNum > 10) { // For S4 follow-up (e.g., Q11, Q12...)
                return `S4: ‡∏ã‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Q1.F${qNum % 10}`;
            }
            if (part === 4) return `S4: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å Q1`;
            
            return `Q${qNum}`;
        }


        function renderSessionDetails(turns) {
            sessionDetailsElement.innerHTML = ''; 
            
            if (turns.length === 0) {
                sessionDetailsElement.innerHTML = '<p class="alert alert-warning text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö Turn ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            turns.forEach((turn, index) => {
                // Determine Turn/Question Display
                const partName = getPartName(turn.part_number);
                const qDisplay = getQuestionDisplay(turn.part_number, turn.question_number);
                
                // Determine Customer Audio URL (fallback to N/A text)
                const customerAudioUrl = turn.customer_audio_url && turn.customer_audio_url.startsWith('http')
                    ? turn.customer_audio_url
                    : 'N/A';
                    
                // Determine Employee Audio URL
                const employeeAudioUrl = turn.audio_url || 'N/A';
                
                const turnItem = document.createElement('div');
                turnItem.className = 'turn-item';
                turnItem.innerHTML = `
                    <div class="turn-header">
                        [Turn ${index + 1}] ${partName} - ${qDisplay}
                    </div>
                    <div>
                        <small><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${turn.question_text || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</small>
                    </div>
                    <div class="audio-pair mt-3">
                        <div class="audio-block customer-audio">
                            <label>üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)</label>
                            ${customerAudioUrl !== 'N/A' 
                                ? `<audio controls class="audio-player" src="${customerAudioUrl}"></audio>` 
                                : `<p class="text-danger small">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Script/‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö)</p>`
                            }
                        </div>
                        <div class="audio-block employee-audio">
                            <label>üé§ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö/Script)</label>
                            ${employeeAudioUrl !== 'N/A' 
                                ? `<audio controls class="audio-player" src="${employeeAudioUrl}"></audio>` 
                                : `<p class="text-danger small">‚ùå URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>`
                            }
                        </div>
                    </div>
                `;
                sessionDetailsElement.appendChild(turnItem);
            });
        }

        // --- 4. Initialization ---

        document.addEventListener('DOMContentLoaded', fetchUsers);
        
    </script>
</body>
</html>
